<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
		<title>Facebook Account Manager</title>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
		<link rel="stylesheet" href="{{ url_for('static', filename='css/global.css') }}">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
		<style>
			/* Định dạng cơ bản cho bảng */
			.table {
				width: 100%;
				table-layout: fixed;
				/* Giúp kiểm soát width tốt hơn */
			}
		
			/* Định dạng từng cột */
			.table th:nth-child(1),
			.table td:nth-child(1) {
				width: 8%;
				/* Cột ID */
			}
		
			.table th:nth-child(2),
			.table td:nth-child(2) {
				width: 15%;
				/* Cột Facebook User ID */
			}
		
			.table th:nth-child(3),
			.table td:nth-child(3) {
				width: 52%;
				/* Cột Access Token - cho nhiều không gian nhất */
			}
		
			.table th:nth-child(4),
			.table td:nth-child(4) {
				width: 25%;
				/* Cột Actions */
			}
		
			/* Cải thiện token wrapper */
			.token-wrapper {
				display: flex;
				align-items: center;
				gap: 8px;
				width: 100%;
				position: relative;
			}
		
			.token-content {
				font-family: monospace;
				/* Sử dụng font monospace cho token */
				background-color: #f8f9fa;
				padding: 6px 8px;
				border-radius: 4px;
				max-height: 2.4em;
				overflow: hidden;
				text-overflow: ellipsis;
				display: -webkit-box;
				-webkit-line-clamp: 1;
				/* Giảm xuống 1 dòng */
				-webkit-box-orient: vertical;
				flex-grow: 1;
				font-size: 0.9em;
			}
		
			/* Style cho nút copy */
			.copy-btn {
				padding: 2px 8px;
				font-size: 0.8em;
				white-space: nowrap;
				flex-shrink: 0;
				/* Ngăn nút bị co lại */
				min-width: 60px;
				/* Đảm bảo nút không bị quá nhỏ */
			}
		
			/* Style cho phần actions */
			td:last-child {
				white-space: nowrap;
				/* Giữ các nút trên cùng một dòng */
				text-align: center;
				/* Căn phải các nút */
			}

			th:last-child {
				white-space: nowrap;
				/* Giữ các nút trên cùng một dòng */
				text-align: center;
				/* Căn phải các nút */
			}
		
			td:last-child form {
				display: inline-block;
				margin-right: 4px;
				/* Khoảng cách giữa các nút */
			}
		
			/* Responsive adjustments */
			@media (max-width: 992px) {
				.token-content {
					-webkit-line-clamp: 2;
					/* Cho phép 2 dòng trên màn hình nhỏ */
				}
		
				td:last-child {
					display: flex;
					flex-wrap: wrap;
					gap: 4px;
					padding: 8px 4px;
				}
		
				td:last-child form,
				td:last-child a {
					flex: 1;
					min-width: 100px;
					margin: 2px;
				}
		
				.btn {
					width: 100%;
					margin: 0;
				}
			}
		</style>
	</head>
	<body>
		{% include 'header.html' %}
		{% include 'message.html' %}
		<div class="container mt-5">
			<h1 class="text-dark mb-4">Facebook Account Manager</h1>

			<h2>Accounts</h2>
			<table class="table table-striped">
				<thead>
					<tr>
						<!-- <th>ID</th> -->
						<th>Facebook User ID</th>
						<!-- <th>Access Token</th> -->
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					{% if accounts|length == 0 %}
					<tr>
						<td colspan="4" class="text-center">No accounts have been added yet</td>
					</tr>
					{% else %}
					{% for account in accounts %}
					<tr>
						<!-- <td>{{ account.id }}</td> -->
						<td>{{ account.facebook_user_id }}</td>

						<td>
							<form action="{{ url_for('facebook.get_pages') }}" method="POST" style="display: inline;">
								{{ form.csrf_token }} <!-- CSRF token -->
								<input type="hidden" name="id" value="{{ account.id }}">
								<input type="hidden" name="access_token" value="{{ account.access_token }}">
								<button type="submit" class="btn btn-info btn-sm">Get Pages</button>
							</form>
							<form action="{{ url_for('facebook.get_account_ads') }}" method="POST" style="display: inline;">
								{{ form.csrf_token }} <!-- CSRF token -->
								<input type="hidden" name="id" value="{{ account.id }}">
								<input type="hidden" name="access_token" value="{{ account.access_token }}">
								<button type="submit" class="btn btn-warning btn-sm">Get Ads</button> <!-- New button for Get Ads -->
							</form>
							<a href="{{ url_for('facebook.delete_fb_account', id=account.id) }}"
								class="btn btn-danger btn-sm">Delete</a>

						</td>
					</tr>
					{% endfor %}
					{% endif %}
				</tbody>
			</table>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
		<script>
			function copyToken(button, token) {
				navigator.clipboard.writeText(token).then(() => {
					button.textContent = 'Copied!';
					button.classList.remove('btn-outline-primary');
					button.classList.add('btn-success');

					setTimeout(() => {
						button.textContent = 'Copy';
						button.classList.remove('btn-success');
						button.classList.add('btn-outline-primary');
					}, 2000);
				}).catch(err => {
					console.error('Failed to copy:', err);
					button.textContent = 'Error';
					button.classList.add('btn-danger');
				});
			}
		</script>

		<script>
			window.fbAsyncInit = function () {
				FB.init({
					appId: '{{ facebook_app_id }}',
					cookie: true,
					xfbml: true,
					version: 'v21.0'
				});

				FB.AppEvents.logPageView();

			};

			(function (d, s, id) {
				var js, fjs = d.getElementsByTagName(s)[0];
				if (d.getElementById(id)) { return; }
				js = d.createElement(s); js.id = id;
				js.src = "https://connect.facebook.net/en_US/sdk.js";
				fjs.parentNode.insertBefore(js, fjs);
			}(document, 'script', 'facebook-jssdk'));

			function fbLogin() {
				FB.login(function (response) {
					if (response.authResponse) {
						const accessToken = response.authResponse.accessToken;
						const userID = response.authResponse.userID;

						// Gọi backend để lưu thông tin tài khoản Facebook
						login_call_backend(accessToken, userID)
					} else {
						console.log("Đăng nhập thất bại!");
						window.location.href = "/account_fb/";
					}
				}, {
					scope: 'email, public_profile, pages_read_engagement,business_management, pages_show_list,ads_read ,ads_management'
				});

				function login_call_backend(accessToken, userID) {
					fetch('/account_fb/add_account', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'X-CSRFToken': '{{ form.csrf_token._value() }}', // Nếu bạn đang sử dụng CSRF protection
						},
						body: JSON.stringify({
							access_token: accessToken,
							facebook_user_id: userID
						})
					})
						.then(response => {
							// Kiểm tra xem phản hồi có phải là JSON không
							if (response.ok) {
								const contentType = response.headers.get("Content-Type");

								// Nếu phản hồi là JSON
								if (contentType && contentType.includes("application/json")) {
									return response.json();
								} else {
									// Nếu phản hồi là HTML (hoặc loại khác), xử lý HTML
									return response.text();
								}
							} else {
								throw new Error("Network response was not ok");
							}
						})
						.then(data => {
							if (typeof data === 'object' && data.success) {
								console.log("Đăng nhập thành công và thông tin đã được lưu!");
								window.location.href = "/account_fb/";
							} else {
								// Nếu phản hồi là HTML, xử lý việc chuyển hướng hoặc hiển thị thông báo lỗi
								console.log("Có lỗi khi lưu thông tin đăng nhập.");
								window.location.href = "/account_fb/"; // Hoặc xử lý theo cách khác
							}
						})
						.catch(error => {
							console.error('Error:', error);
							alert("Đã xảy ra lỗi khi đăng nhập.");
						});
				}
			}
		</script>
	</body>
</html>