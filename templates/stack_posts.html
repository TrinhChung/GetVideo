<!DOCTYPE html>
<html lang="vi">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Danh Sách Bài Đăng</title>
		<link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="{{ url_for('static', filename='css/global.css') }}">
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	</head>
	<body>
		{% include 'header.html' %}
		{% include 'message.html' %}

		<div class="container mt-5">
			<h1 class="text-center mb-4">Danh Sách Bài Đăng</h1>
			{% if page_id or status %}
			<div class="alert alert-info">
				Bộ lọc:
				{% if page_id %}
				Trang: {{ pages|selectattr("page_id", "equalto", page_id)|map(attribute="name")|first }}
				{% endif %}
				{% if status %}
				, Trạng thái: {{ status }}
				{% endif %}
			</div>
			{% endif %}

			<!-- Form lọc theo page và status -->
			<form method="GET" id="filter_record" action="{{ url_for('stack_post.index') }}">
				<div class="row mb-4">
					<!-- Lọc theo Trang -->
					<div class="col-md-4">
						<label for="page_id" class="form-label">Chọn Trang</label>
						<select name="page_id" id="page_id" class="form-select">
							<option value="">Tất cả trang</option>
							{% for page in pages %}
							<option value="{{ page.page_id }}" {% if page.page_id|string == page_id %} selected {% endif %}>
								{{ page.name }}
							</option>
							{% endfor %}
						</select>
					</div>

					<!-- Lọc theo Trạng Thái -->
					<div class="col-md-4">
						<label for="status" class="form-label">Chọn Trạng Thái</label>
						<select name="status" id="status" class="form-select">
							<option value="">Tất cả trạng thái</option>
							<option value="waiting" {% if status == 'waiting' %} selected {% endif %}>Chờ</option>
							<option value="processing" {% if status == 'processing' %} selected {% endif %}>Đang xử lý</option>
							<option value="posted" {% if status == 'posted' %} selected {% endif %}>Đã đăng</option>
							<option value="error" {% if status == 'error' %} selected {% endif %}>Lỗi</option>
						</select>
					</div>

					<!-- Nút Lọc -->
					<div class="col-md-4 d-flex align-items-end">
						<button type="submit" form="filter_record" class="btn btn-primary">Lọc</button>
					</div>
				</div>
			</form>
			<!-- Bảng hiển thị danh sách bài đăng -->
			<form method="POST" id="delete-form" action="{{ url_for('stack_post.delete_selected') }}">
				{{ form.csrf_token }}
				<button type="submit" form="delete-form" class="btn btn-danger mb-3">Xóa tất cả đã chọn</button>
				<table class="table table-bordered table-striped">
					<thead class="table-light">
						<tr>
							<th><input type="checkbox" id="select-all" /></th>
							<th>Tiêu Đề</th>
							<th>Trang</th>
							<th>Thời Gian</th>
							<th>Trạng Thái</th>
							<th>Thao Tác</th>
						</tr>
					</thead>
					<tbody>
						<form></form>
						{% for post in stack_posts %}
						<tr>
							<td>
								<input type="checkbox" name="selected_posts[]" value="{{ post.id }}" class="select-checkbox" />
							</td>
							<td>{{ post.title }}</td>
							<td>{{ post.page.name }}</td>
							<td>{{ post.time }}</td>
							<td>
								<span class="badge {% if post.status == 'waiting' %}bg-warning{% endif %}{% if post.status == 'processing' %}bg-info{% endif %}{% if post.status == 'posted' %}bg-success{% endif %}{% if post.status == 'error' %}bg-danger{% endif %}">
									{{ post.status }}
								</span>
							</td>
							<td>
								{% if loop.index0 == 0 %}
                					<!-- First post ID: {{ post.id }} -->
                					<!-- First post status: {{ post.status }} -->
            					{% endif %}
								<form id="post_form_request_{{ post.id }}" 
                  					method="POST" 
                  					action="{{ url_for('stack_post.post_video', post_id=post.id) }}" 
                  					class="d-inline">
                					{{ form.csrf_token }}
									<button form="post_form_request_{{ post.id }}" type="submit" class="btn btn-primary btn-sm">Đăng Video</button>
								</form>
							</td>
						</tr>
						{% else %}
						<tr>
							<td colspan="6" class="text-center">Không có bài đăng nào.</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</form>
		</div>

		<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script> -->
		<script>
			// Script để chọn tất cả checkbox
			document.getElementById('select-all').addEventListener('click', function (e) {
				const checkboxes = document.querySelectorAll('input[name="selected_posts[]"]');
				checkboxes.forEach(checkbox => {
					checkbox.checked = e.target.checked;
				});
			});
		</script>
	</body>
</html>